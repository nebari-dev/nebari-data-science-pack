# Build and push multi-arch images to:
# - GitHub Container Registry (ghcr.io)
# - Red Hat Container Registry (quay.io)
#
# Uses native runners for each architecture (no QEMU emulation) for faster builds.
# Reference: https://docs.docker.com/build/ci/github-actions/multi-platform/
name: "Build Docker Images"

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "images/**"
      - ".github/workflows/build-image.yaml"
      - ".github/workflows/build-images.yaml"
    tags:
      - "*"
  pull_request:
    paths:
      - "images/**"
      - ".github/workflows/build-image.yaml"
      - ".github/workflows/build-images.yaml"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  jupyterlab-base:
    name: "jupyterlab-base"
    uses: ./.github/workflows/build-image.yaml
    with:
      image: nebari-data-science-pack-jupyterlab-base
      target: jupyterlab-base
    secrets:
      QUAY_TOKEN: ${{ secrets.QUAY_TOKEN }}

  jupyterlab:
    name: "jupyterlab"
    uses: ./.github/workflows/build-image.yaml
    with:
      image: nebari-data-science-pack-jupyterlab
      target: jupyterlab
    secrets:
      QUAY_TOKEN: ${{ secrets.QUAY_TOKEN }}

  jupyterlab-gpu-base:
    name: "jupyterlab-gpu-base"
    uses: ./.github/workflows/build-image.yaml
    with:
      image: nebari-data-science-pack-jupyterlab-gpu-base
      target: jupyterlab-base
      build_arm64: false
      base_image: "nvidia/cuda:12.8.1-base-ubuntu24.04"
      gpu: true
    secrets:
      QUAY_TOKEN: ${{ secrets.QUAY_TOKEN }}

  jupyterlab-gpu:
    name: "jupyterlab-gpu"
    uses: ./.github/workflows/build-image.yaml
    with:
      image: nebari-data-science-pack-jupyterlab-gpu
      target: jupyterlab
      build_arm64: false
      base_image: "nvidia/cuda:12.8.1-base-ubuntu24.04"
      gpu: true
    secrets:
      QUAY_TOKEN: ${{ secrets.QUAY_TOKEN }}

  jupyterhub:
    name: "jupyterhub"
    uses: ./.github/workflows/build-image.yaml
    with:
      image: nebari-data-science-pack-jupyterhub
      target: jupyterhub
    secrets:
      QUAY_TOKEN: ${{ secrets.QUAY_TOKEN }}

name: Test Deployment

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          docker system prune -af

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2  # v3.10.0

      - name: Install k3d
        run: curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

      - name: Create k3d cluster
        run: k3d cluster create test --wait

      - name: Install Helm
        run: |
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Update Helm dependencies
        run: helm dependency update

      - name: Build images locally
        run: |
          docker buildx build \
            --target jupyterhub \
            --cache-from type=gha,scope=jupyterhub \
            --cache-to type=gha,scope=jupyterhub,mode=max \
            --load \
            -t nebari-jupyterhub:test \
            ./images
          docker buildx build \
            --target jupyterlab \
            --cache-from type=gha,scope=jupyterlab \
            --cache-to type=gha,scope=jupyterlab,mode=max \
            --load \
            -t nebari-jupyterlab:test \
            ./images

      - name: Import images to k3d
        run: k3d image import nebari-jupyterhub:test nebari-jupyterlab:test -c test

      - name: Deploy chart
        run: |
          helm install data-science-pack . --namespace default \
            --set jupyterhub.hub.image.name=nebari-jupyterhub \
            --set jupyterhub.hub.image.tag=test \
            --set jupyterhub.singleuser.image.name=nebari-jupyterlab \
            --set jupyterhub.singleuser.image.tag=test

      - name: Wait for pods with progress
        run: |
          for i in {1..60}; do
            echo "=== Attempt $i/60 ==="
            kubectl get pods
            echo "--- Hub logs (last 10 lines) ---"
            kubectl logs -l component=hub --tail=10 2>/dev/null || echo "(not ready)"
            echo "--- Proxy logs (last 5 lines) ---"
            kubectl logs -l component=proxy --tail=5 2>/dev/null || echo "(not ready)"
            if kubectl wait --for=condition=ready pod -l component=hub --timeout=5s 2>/dev/null && \
               kubectl wait --for=condition=ready pod -l component=proxy --timeout=5s 2>/dev/null; then
              echo "All pods ready!"
              exit 0
            fi
            sleep 5
          done
          echo "Timeout waiting for pods"
          exit 1

      - name: Test JupyterHub endpoint
        run: |
          kubectl port-forward svc/proxy-public 8000:80 &
          PF_PID=$!
          sleep 5
          curl -sf http://localhost:8000/hub/login | grep -q "JupyterHub"
          RESULT=$?
          kill $PF_PID 2>/dev/null || true
          exit $RESULT

      - name: Check hub logs for errors
        if: failure()
        run: kubectl logs -l component=hub --tail=100

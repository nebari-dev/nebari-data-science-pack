# Default values for nebari-data-science-pack
# This is a YAML-formatted file.

# =============================================================================
# Nebari Integration
# =============================================================================
# Creates a NebariApp CRD that configures routing and auth via nebari-operator.
# Set to false when deploying outside of Nebari.
nebariapp:
  enabled: true
  # hostname: jupyter.nic.local  # Required when enabled
  service:
    # JupyterHub proxy service (created by jupyterhub subchart)
    name: proxy-public
    port: 80
  # routing:
  #   routes:
  #     - pathPrefix: /
  #       pathType: Exact
  auth:
    enabled: true
    provider: keycloak
    provisionClient: true
    redirectURI: /hub/oauth_callback  # JupyterHub's OAuth callback
    scopes:
      - openid
      - profile
      - email
      - groups

# Shared storage configuration (disabled - requires RWX storage class)
sharedStorage:
  enabled: false
  storageClass: ""  # Leave empty to use cluster default
  size: 10Gi
  accessModes:
    - ReadWriteMany

# JupyterHub configuration
# All values under this key are passed to the jupyterhub subchart
jupyterhub:
  # custom is read by z2jh's get_config("custom.<key>") in hub config files.
  # external-url is used by 02-jhub-apps.py to set JupyterHub.bind_url so that
  # internal OAuth redirects use the real hostname instead of 0.0.0.0.
  custom:
    external-url: ""
    # jhub-apps (JAppsConfig) overrides.
    # Any key here is set as an attribute on c.JAppsConfig before install_jhub_apps().
    # See https://jhub-apps.nebari.dev/docs/configuration for available options.
    japps-config:
      hub_host: "hub"
      service_workers: 4
      # app_title: "JHub Apps Launcher"
      # app_icon: ""
      # conda_envs: []
      # allowed_frameworks: []
      # blocked_frameworks: []
      # additional_services: []
      # startup_apps: []
  hub:
    # Custom Nebari hub image with jhub-apps pre-installed
    image:
      name: quay.io/nebari/nebari-data-science-pack-jupyterhub@sha256
      tag: "4a3ddf08d87736d3de5a8d1d520ed5038e3bd3c0d4e029cd3452e7e7fbced3a2"

    config:
      JupyterHub:
        admin_access: true
        # Default authenticator for local development - any username/password works
        # For production, use GenericOAuthenticator with Keycloak (see below)
        authenticator_class: dummy

      # ============================================================
      # Optional: Keycloak/OAuth Configuration
      # ============================================================
      # To enable OAuth authentication with Keycloak or another IdP,
      # uncomment and configure the following section:
      #
      # JupyterHub:
      #   authenticator_class: generic-oauth
      #
      # GenericOAuthenticator:
      #   client_id: jupyterhub
      #   client_secret: <your-client-secret>
      #   oauth_callback_url: https://<your-domain>/hub/oauth_callback
      #   authorize_url: https://<keycloak-host>/realms/<realm>/protocol/openid-connect/auth
      #   token_url: https://<keycloak-host>/realms/<realm>/protocol/openid-connect/token
      #   userdata_url: https://<keycloak-host>/realms/<realm>/protocol/openid-connect/userinfo
      #   login_service: "Keycloak"
      #   username_claim: "preferred_username"
      #   scope:
      #     - openid
      #     - profile
      #     - email
      # ============================================================

    # Mount custom config files from ConfigMap
    extraVolumes:
      - name: custom-config
        configMap:
          name: data-science-pack-hub-config

    extraVolumeMounts:
      - name: custom-config
        mountPath: /usr/local/etc/jupyterhub/jupyterhub_config.d/

    service:
      extraPorts:
        - port: 10202
          targetPort: 10202
          name: jhub-apps

    networkPolicy:
      enabled: true
      ingress:
        - ports:
            - port: 10202  # jhub-apps service port

  singleuser:
    image:
      name: quay.io/nebari/nebari-data-science-pack-jupyterlab@sha256
      tag: "ac46fa18b712758f025c87d21cc5faf3c4bb553d4ae70ae8e16ff46beabae661"
    defaultUrl: "/lab"
    extraEnv:
      JUPYTERHUB_SINGLEUSER_APP: "jupyter_server.serverapp.ServerApp"

    # Storage: type "none" required because jhub-apps' JHubSpawner expects volumes
    # as a list, but the subchart's dynamic storage generates a dict.
    # Home directory PVC is configured in 01-spawner.py instead.
    storage:
      type: none

  proxy:
    service:
      type: ClusterIP
    chp:
      networkPolicy:
        egress:
          - ports:
              - port: 10202
                protocol: TCP

  scheduling:
    userScheduler:
      enabled: false

  cull:
    enabled: true
    timeout: 3600
    every: 300
